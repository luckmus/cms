<?phptry{header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");header("Cache-Control: no-store, no-cache, must-revalidate");header("Cache-Control: post-check=0, pre-check=0", false);header("Pragma: no-cache");     header("Content-type: text/html; charset=windows-1251");include "../../em/em_promo.php";include "../../em/em_cart.php";       include "../../em/em_goods.php";       require_once "../../../config.php";     require_once "../../../libs/db.php";     require_once "../../../libs/vars.php";          require_once "../../../libs/helpers.php";     @$dbh=DBConnect($DBHost, $DBUser, $DBPass, $DBName);mQuery("SET NAMES 'cp1251'", $dbh);         require_once "../../../libs/init_settings_var.php";     $promo = strip_Tags($_GET['promo']);$cart = new Cart();$summ = $cart->getTotal();if (trim($promo)!=''){        @$promCode = Promo::getPromoByName($promo);        if ($promCode!= null){            $minusSum = $cart->calcDiscountSum($promCode->value);            $summ = $cart->getTotalWithDiscount($promCode->value);            echo '{"name":"'.$promo.'","id":"'.$promCode->id.'", "value": "'.$promCode->value.'", "summ":"'.$summ.'","minusSum":"'.$minusSum.'", "currency": "'. $GLOBALS[_CURRENCY].'"}';               } else{            echo '{"value": "0", "msg":"Промо-код не найден или его срок действия истек", "summ":"'.$summ.'"}';                                     }    }    else{        echo '{"value": "0", "msg":"Промо-код не передан", "summ":"'.$summ.'"}';                   }}catch(Exception $e)    {    echo '{"value": "0", "msg":"Ошибка. Использовать промо-код невозможно, "summ":"'.$summ.'"}';                              }?>